// Prisma Schema for Auth Module
// Database: PostgreSQL
// Schema: auth (khớp với infrastructure/postgres/01-create-tables.sql)

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["auth", "content"]
}

// ========================================
// ENUMS
// ========================================

enum UserStatus {
  active
  suspended
  deleted

  @@schema("auth")
}

enum Platform {
  ios
  android

  @@schema("auth")
}

enum PushProvider {
  apns
  fcm

  @@schema("auth")
}

// ========================================
// AUTH MODELS (7 tables)
// ========================================

// 1) users
model User {
  userId           String    @id @default(dbgenerated("uuid_generate_v4()")) @map("user_id") @db.Uuid
  email            String?   @unique @db.VarChar(255)
  phone            String?   @unique @db.VarChar(50)
  passwordHash     String    @map("password_hash") @db.VarChar(255)
  displayName      String    @map("display_name") @db.VarChar(255)
  avatarAssetId    String?   @map("avatar_asset_id") @db.Uuid
  status           UserStatus @default(active)
  dob              DateTime? @db.Date
  nativeLanguageId Int?      @map("native_language_id")
  timezone         String    @default("UTC") @db.VarChar(100)
  lastLoginAt      DateTime? @map("last_login_at") @db.Timestamptz(6)
  createdAt        DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  userRoles    UserRole[]
  authSessions AuthSession[]
  userDevices  UserDevice[]
  avatarAsset  MediaAsset?   @relation(fields: [avatarAssetId], references: [assetId], onDelete: SetNull)

  @@map("users")
  @@schema("auth")
}

// 2) roles
model Role {
  roleId    Int      @id @default(autoincrement()) @map("role_id")
  code      String   @unique @db.VarChar(50)
  name      String   @db.VarChar(255)
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  userRoles UserRole[]

  @@map("roles")
  @@schema("auth")
}

// 3) user_roles
model UserRole {
  userId    String   @map("user_id") @db.Uuid
  roleId    Int      @map("role_id")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user User @relation(fields: [userId], references: [userId], onDelete: Cascade)
  role Role @relation(fields: [roleId], references: [roleId], onDelete: Cascade)

  @@id([userId, roleId])
  @@map("user_roles")
  @@schema("auth")
}

// 4) auth_sessions
model AuthSession {
  sessionId       String    @id @default(dbgenerated("uuid_generate_v4()")) @map("session_id") @db.Uuid
  userId          String    @map("user_id") @db.Uuid
  deviceId        String?   @map("device_id") @db.Uuid
  accessTokenHash String    @map("access_token_hash") @db.VarChar(255)
  ip              String?   @db.VarChar(45)
  userAgent       String?   @db.Text
  expiresAt       DateTime  @map("expires_at") @db.Timestamptz(6)
  revokedAt       DateTime? @map("revoked_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  user          User           @relation(fields: [userId], references: [userId], onDelete: Cascade)
  device        UserDevice?    @relation(fields: [deviceId], references: [deviceId], onDelete: SetNull)
  refreshTokens RefreshToken[]

  @@index([userId])
  @@index([accessTokenHash])
  @@map("auth_sessions")
  @@schema("auth")
}

// 5) refresh_tokens
model RefreshToken {
  refreshTokenId String    @id @default(dbgenerated("uuid_generate_v4()")) @map("refresh_token_id") @db.Uuid
  sessionId      String    @map("session_id") @db.Uuid
  tokenHash      String    @unique @map("token_hash") @db.VarChar(255)
  expiresAt      DateTime  @map("expires_at") @db.Timestamptz(6)
  revokedAt      DateTime? @map("revoked_at") @db.Timestamptz(6)
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  // Relations
  session AuthSession @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)

  @@index([sessionId])
  @@map("refresh_tokens")
  @@schema("auth")
}

// 6) user_devices
model UserDevice {
  deviceId          String   @id @default(dbgenerated("uuid_generate_v4()")) @map("device_id") @db.Uuid
  userId            String   @map("user_id") @db.Uuid
  platform          Platform
  deviceModel       String?  @map("device_model") @db.VarChar(255)
  osVersion         String?  @map("os_version") @db.VarChar(50)
  appVersion        String?  @map("app_version") @db.VarChar(50)
  deviceFingerprint String?  @map("device_fingerprint") @db.VarChar(255)
  locale            String?  @db.VarChar(10)
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  user         User          @relation(fields: [userId], references: [userId], onDelete: Cascade)
  authSessions AuthSession[]
  pushTokens   PushToken[]

  @@index([userId])
  @@map("user_devices")
  @@schema("auth")
}

// 7) push_tokens
model PushToken {
  pushTokenId      String       @id @default(dbgenerated("uuid_generate_v4()")) @map("push_token_id") @db.Uuid
  deviceId         String       @map("device_id") @db.Uuid
  token            String       @unique @db.Text
  provider         PushProvider
  isActive         Boolean      @default(true) @map("is_active")
  lastRegisteredAt DateTime     @default(now()) @map("last_registered_at") @db.Timestamptz(6)
  createdAt        DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt        DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  device UserDevice @relation(fields: [deviceId], references: [deviceId], onDelete: Cascade)

  @@map("push_tokens")
  @@schema("auth")
}

// ========================================
// CONTENT MODELS (minimal for FK reference)
// ========================================

model MediaAsset {
  assetId         String   @id @default(dbgenerated("uuid_generate_v4()")) @map("asset_id") @db.Uuid
  storageProvider String   @map("storage_provider") @db.VarChar(50)
  fileUrl         String   @map("file_url") @db.Text
  mimeType        String   @map("mime_type") @db.VarChar(100)
  fileSizeBytes   BigInt?  @map("file_size_bytes")
  checksum        String?  @db.VarChar(255)
  createdBy       String?  @map("created_by") @db.Uuid
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  // Relations
  users User[]

  @@map("media_assets")
  @@schema("content")
}
