name: üîç Pull Request Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  # =====================================================
  # PR Title Check
  # =====================================================
  pr-title-check:
    name: üìù PR Title Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üîç Check PR title format
        uses: amannn/action-semantic-pull-request@v5
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          types: |
            feat
            fix
            docs
            style
            refactor
            perf
            test
            chore
          requireScope: false
          subjectPattern: ^[A-Z].+$
          subjectPatternError: |
            The subject "{subject}" found in the pull request title "{title}"
            didn't match the configured pattern. Please ensure that the subject
            starts with an uppercase character.

  # =====================================================
  # Check Guidelines Compliance
  # =====================================================
  guidelines-check:
    name: üìö Guidelines Compliance Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Check for large files
        run: |
          echo "üîç Checking changed files for size violations..."
          
          # Get changed files
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          VIOLATIONS=0
          for file in $CHANGED_FILES; do
            if [[ -f "$file" ]] && [[ "$file" =~ \.(ts|tsx|js|jsx)$ ]]; then
              LINES=$(wc -l < "$file" 2>/dev/null || echo "0")
              if [ "$LINES" -gt 500 ]; then
                echo "‚ùå $file: $LINES lines (max: 500)"
                VIOLATIONS=$((VIOLATIONS + 1))
              fi
            fi
          done
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "‚ùå $VIOLATIONS file(s) exceed 500 lines!"
            echo "üìñ See .github/COPILOT_INSTRUCTIONS.md"
            exit 1
          else
            echo "‚úÖ All changed files comply with size limit"
          fi
      
      - name: üîç Check for prohibited patterns
        run: |
          echo "üîç Checking for prohibited code patterns..."
          
          VIOLATIONS=0
          
          # Check for console.log in production code
          if git diff origin/${{ github.base_ref }}...HEAD | grep "^+.*console\.log"; then
            echo "‚ö†Ô∏è  WARNING: Found console.log in changes"
          fi
          
          # Check for TODO without ticket reference
          if git diff origin/${{ github.base_ref }}...HEAD | grep "^+.*TODO" | grep -v "TODO:.*#[0-9]"; then
            echo "‚ö†Ô∏è  WARNING: Found TODO without ticket reference"
          fi
          
          # Check for any type usage
          if git diff origin/${{ github.base_ref }}...HEAD -- "*.ts" "*.tsx" | grep "^+.*: any"; then
            echo "‚ùå VIOLATION: Found 'any' type usage"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "‚ùå Found code pattern violations!"
            exit 1
          else
            echo "‚úÖ No prohibited patterns found"
          fi

  # =====================================================
  # PR Size Check
  # =====================================================
  pr-size-check:
    name: üìè PR Size Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Check PR size
        run: |
          echo "üîç Checking PR size..."
          
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | wc -l)
          CHANGED_LINES=$(git diff --stat origin/${{ github.base_ref }}...HEAD | tail -1 | grep -oE '[0-9]+ insertions' | grep -oE '[0-9]+' || echo "0")
          
          echo "üìä Files changed: $CHANGED_FILES"
          echo "üìä Lines changed: $CHANGED_LINES"
          
          if [ "$CHANGED_FILES" -gt 50 ]; then
            echo "‚ö†Ô∏è  WARNING: Large PR ($CHANGED_FILES files)"
            echo "Consider splitting into smaller PRs"
          fi
          
          if [ "$CHANGED_LINES" -gt 1000 ]; then
            echo "‚ö†Ô∏è  WARNING: Large PR ($CHANGED_LINES lines)"
            echo "Consider splitting into smaller PRs"
          fi

  # =====================================================
  # Check Required Files Updated
  # =====================================================
  documentation-check:
    name: üìñ Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Check if docs need update
        run: |
          echo "üîç Checking if documentation needs update..."
          
          CHANGED_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          
          # Check if architecture changed but docs not updated
          if echo "$CHANGED_FILES" | grep -q "src/domain\|src/infrastructure"; then
            if ! echo "$CHANGED_FILES" | grep -q "docs/"; then
              echo "‚ö†Ô∏è  WARNING: Domain/Infrastructure changed but no doc updates"
              echo "Consider updating ARCHITECTURE.md or BACKEND_GUIDELINES.md"
            fi
          fi
          
          # Check if new feature added
          if echo "$CHANGED_FILES" | grep -q "src/modules/.*/.*.module.ts$"; then
            if ! echo "$CHANGED_FILES" | grep -q "README.md"; then
              echo "‚ö†Ô∏è  WARNING: New module added, consider updating README.md"
            fi
          fi

  # =====================================================
  # Security Check
  # =====================================================
  security-check:
    name: üîí Security Check
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: üîç Check for secrets
        run: |
          echo "üîç Checking for accidentally committed secrets..."
          
          VIOLATIONS=0
          
          # Check for common secret patterns in diff
          if git diff origin/${{ github.base_ref }}...HEAD | grep -iE "password.*=.*['\"]|api_key.*=.*['\"]|secret.*=.*['\"]|token.*=.*['\"]"; then
            echo "‚ùå POTENTIAL SECRET FOUND in code!"
            echo "Make sure you're not committing real credentials"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check for hardcoded IPs
          if git diff origin/${{ github.base_ref }}...HEAD | grep -E "[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}"; then
            echo "‚ö†Ô∏è  WARNING: Found hardcoded IP addresses"
          fi
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            exit 1
          else
            echo "‚úÖ No secrets detected"
          fi

  # =====================================================
  # Final PR Status
  # =====================================================
  pr-status:
    name: ‚úÖ PR Status
    runs-on: ubuntu-latest
    needs:
      - pr-title-check
      - guidelines-check
      - pr-size-check
      - documentation-check
      - security-check
    if: always()
    
    steps:
      - name: üìã PR Check Summary
        run: |
          echo "üìä PR Checks Summary:"
          echo "===================="
          echo "Title: ${{ needs.pr-title-check.result }}"
          echo "Guidelines: ${{ needs.guidelines-check.result }}"
          echo "Size: ${{ needs.pr-size-check.result }}"
          echo "Documentation: ${{ needs.documentation-check.result }}"
          echo "Security: ${{ needs.security-check.result }}"
          echo "===================="
          
          if [ "${{ needs.pr-title-check.result }}" != "success" ] || \
             [ "${{ needs.guidelines-check.result }}" != "success" ] || \
             [ "${{ needs.security-check.result }}" != "success" ]; then
            echo "‚ùå Some PR checks failed!"
            exit 1
          else
            echo "‚úÖ All PR checks passed!"
          fi
