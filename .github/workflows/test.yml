name: ğŸ§ª Test All Apps

on:
  push:
    branches:
      - main
      - develop
      - feature/**
      - fix/**
  pull_request:
    branches:
      - main
      - develop

jobs:
  # =====================================================
  # Backend API Tests
  # =====================================================
  backend-api-test:
    name: ğŸ”§ Backend API Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    defaults:
      run:
        working-directory: ./apps/backend-api
    
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
          POSTGRES_DB: test_db
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
      
      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: apps/backend-api/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Lint check
        run: npm run lint
      
      - name: ğŸ—ï¸ Build
        run: npm run build
      
      - name: ğŸ§ª Run unit tests
        run: npm run test
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test_jwt_secret_key_for_testing
          JWT_REFRESH_SECRET: test_jwt_refresh_secret_key
      
      - name: ğŸ§ª Run e2e tests
        run: npm run test:e2e
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          REDIS_HOST: localhost
          REDIS_PORT: 6379
          JWT_SECRET: test_jwt_secret_key_for_testing
          JWT_REFRESH_SECRET: test_jwt_refresh_secret_key
      
      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/backend-api/coverage/lcov.info
          flags: backend-api
          name: backend-api-coverage
        if: always()

  # =====================================================
  # Mobile App Tests
  # =====================================================
  mobile-app-test:
    name: ğŸ“± Mobile App Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    defaults:
      run:
        working-directory: ./apps/mobile-app
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: apps/mobile-app/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Lint check
        run: npm run lint
        continue-on-error: true
      
      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit
      
      - name: ğŸ§ª Run tests
        run: npm test -- --coverage --watchAll=false
      
      - name: ğŸ“Š Upload coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./apps/mobile-app/coverage/lcov.info
          flags: mobile-app
          name: mobile-app-coverage
        if: always()

  # =====================================================
  # Admin Web Tests
  # =====================================================
  admin-web-test:
    name: ğŸŒ Admin Web Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    defaults:
      run:
        working-directory: ./apps/admin-web
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: apps/admin-web/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
      
      - name: ğŸ” Lint check
        run: npm run lint
        continue-on-error: true
      
      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit
        continue-on-error: true
      
      - name: ğŸ—ï¸ Build
        run: npm run build
        continue-on-error: true
      
      - name: ğŸ§ª Run tests
        run: npm test
        continue-on-error: true

  # =====================================================
  # Shared Packages Tests
  # =====================================================
  shared-types-test:
    name: ğŸ“¦ Shared Types Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x]
    
    defaults:
      run:
        working-directory: ./packages/shared-types
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸŸ¢ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
          cache-dependency-path: packages/shared-types/package-lock.json
      
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        continue-on-error: true
      
      - name: ğŸ” TypeScript check
        run: npx tsc --noEmit
      
      - name: ğŸ—ï¸ Build
        run: npm run build
        continue-on-error: true

  # =====================================================
  # File Size Check (< 500 lines rule)
  # =====================================================
  file-size-check:
    name: ğŸ“ File Size Check (<500 lines)
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check file size limit
        run: |
          echo "ğŸ” Checking for files > 500 lines..."
          
          VIOLATIONS=0
          
          # Check TypeScript/JavaScript files
          while IFS= read -r file; do
            LINES=$(wc -l < "$file")
            if [ "$LINES" -gt 500 ]; then
              echo "âŒ VIOLATION: $file has $LINES lines (max: 500)"
              VIOLATIONS=$((VIOLATIONS + 1))
            fi
          done < <(find apps packages -type f \( -name "*.ts" -o -name "*.tsx" -o -name "*.js" -o -name "*.jsx" \) -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" -not -path "*/.next/*")
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "âŒ Found $VIOLATIONS file(s) exceeding 500 lines limit!"
            echo "ğŸ“– See BACKEND_GUIDELINES.md and FE_GUIDELINES.md for file size rules"
            exit 1
          else
            echo "âœ… All files are within the 500 lines limit!"
          fi

  # =====================================================
  # Architecture Rules Check
  # =====================================================
  architecture-check:
    name: ğŸ›ï¸ Architecture Rules Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
      
      - name: ğŸ” Check Backend architecture rules
        run: |
          echo "ğŸ” Checking Backend Clean Architecture rules..."
          
          VIOLATIONS=0
          
          # Check: Domain should not import NestJS
          if grep -r "from '@nestjs" apps/backend-api/src/domain 2>/dev/null; then
            echo "âŒ VIOLATION: Domain layer imports NestJS"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check: Domain should not import Prisma
          if grep -r "from '@prisma" apps/backend-api/src/domain 2>/dev/null; then
            echo "âŒ VIOLATION: Domain layer imports Prisma"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          # Check: No business logic in controllers (basic heuristic)
          if grep -r "implements\|calculate\|validate" apps/backend-api/src/modules/*/[^/]*\.controller\.ts 2>/dev/null | grep -v "class\|import"; then
            echo "âš ï¸  WARNING: Controllers might contain business logic"
          fi
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "âŒ Found $VIOLATIONS architecture violation(s)!"
            echo "ğŸ“– See BACKEND_GUIDELINES.md for architecture rules"
            exit 1
          else
            echo "âœ… Backend architecture rules passed!"
          fi
      
      - name: ğŸ” Check Frontend architecture rules
        run: |
          echo "ğŸ” Checking Frontend architecture rules..."
          
          VIOLATIONS=0
          
          # Check: No business logic in app/ (routing layer)
          if grep -r "useState\|useEffect" apps/mobile-app/src/app 2>/dev/null | grep -v "_layout\|import"; then
            echo "âš ï¸  WARNING: Routing layer might contain business logic"
          fi
          
          # Check: No direct fetch in components (should use React Query)
          if grep -r "fetch(" apps/mobile-app/src/features/*/components 2>/dev/null; then
            echo "âŒ VIOLATION: Components using direct fetch (use React Query)"
            VIOLATIONS=$((VIOLATIONS + 1))
          fi
          
          if [ "$VIOLATIONS" -gt 0 ]; then
            echo ""
            echo "âŒ Found $VIOLATIONS architecture violation(s)!"
            echo "ğŸ“– See FE_GUIDELINES.md for architecture rules"
            exit 1
          else
            echo "âœ… Frontend architecture rules passed!"
          fi

  # =====================================================
  # Final Status
  # =====================================================
  test-summary:
    name: ğŸ“Š Test Summary
    runs-on: ubuntu-latest
    needs: 
      - backend-api-test
      - mobile-app-test
      - admin-web-test
      - shared-types-test
      - file-size-check
      - architecture-check
    if: always()
    
    steps:
      - name: ğŸ“‹ Check test results
        run: |
          echo "ğŸ¯ Test Summary:"
          echo "=================="
          echo "Backend API: ${{ needs.backend-api-test.result }}"
          echo "Mobile App: ${{ needs.mobile-app-test.result }}"
          echo "Admin Web: ${{ needs.admin-web-test.result }}"
          echo "Shared Types: ${{ needs.shared-types-test.result }}"
          echo "File Size Check: ${{ needs.file-size-check.result }}"
          echo "Architecture Check: ${{ needs.architecture-check.result }}"
          echo "=================="
          
          if [ "${{ needs.backend-api-test.result }}" != "success" ] || \
             [ "${{ needs.file-size-check.result }}" != "success" ] || \
             [ "${{ needs.architecture-check.result }}" != "success" ]; then
            echo "âŒ Some tests failed!"
            exit 1
          else
            echo "âœ… All tests passed!"
          fi
